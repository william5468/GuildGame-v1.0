<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>失われし冒険の旅</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="icon" type="image/png" href="favicon.png">
<!-- === 更新された共通スタイル： <head> 内の重複した <style> を削除し、この1つの <style> に置き換えてください === -->
<style>
.sprite-wrapper {
  width: inherit;
  height: inherit;

  position: relative;
  overflow: hidden;
  margin: 0 auto;
  border-radius: 12px;
}

.sprite-wrapper::after {
  content: "";
  position: absolute;
  inset: 0;
  background-image: var(--fallback-img), url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMjAiIGhlaWdodD0iNDAwIiB2aWV3Qm94PSIwIDAgMjIwIDQwMCI+PHJlY3Qgd2lkdGg9IjIyMCIgaGVpZ2h0PSI0MDAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSIxMTAiIHk9IjIwMCIgZm9udC1zaXplPSIzMCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuOCpuODiOOBpzwvdGV4dD48L3N2Zz4=');
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 1;
  transition: opacity 0.5s ease;
  pointer-events: none;
}

.sprite-wrapper.animated::after {
  opacity: 0;
}

.sprite-breathing {
  background-repeat: no-repeat;
  background-color: transparent;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(var(--scale)) translateY(var(--vertical-offset, 0%));
  transform-origin: center center;
  image-rendering: pixelated;
}
</style>
    
</head>
<body>
        <!-- ローディング画面 -->
    <div id="loadingOverlay">
        <div class="loader">
            <h2 data-i18n="loading_header">ギルドマスター v1.0<br>読み込み中...</h2>
            <div class="spinner"></div>
            <p id="loadProgress">0%</p>
        </div>
        <button id="readyBtn" style="display:none;" onclick="startGame()" data-i18n="new_game_button">最初から始める</button>
        <br>
        <button id="skipIntroBtn" style="display:none;" onclick="skipIntro()" data-i18n="continue_button">続きから始める</button>
        <br>
        <select id="langSelect" onchange="setLanguage(this.value)" style="padding:8px 12px; margin:5px; font-size:1em;">
            <option value="en">Please Select Language</option>
            <option value="zh">繁體中文</option>
            <option value="ja">日本語</option>
            <option value="en">English</option>
        </select>        
    </div>

    <h2 data-i18n="game_title">失われし冒険の旅 v1.0</h2>

    <!-- メインBGM -->
    <audio id="bgm" loop preload="auto">
        <source src="Audio/bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>
    
    <!-- イントロ専用BGM -->
    <audio id="introBgm" loop preload="auto">
        <source src="Audio/yume.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>
    <audio id="dialogueBgm" loop preload="auto">
        <source src="Audio/dialogue_bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>   
        <audio id="GameoverBgm" loop preload="auto">
        <source src="Audio/Gameover.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>  
    <audio id="battleBgm" loop preload="auto">
        <source src="Audio/battle.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleBgm2" loop preload="auto">
        <source src="Audio/battle2.mp3" type="audio/mpeg">
    </audio>
    <div id="introModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;">
        <div>
            
        <!-- ステップ1: 名前入力 (translatable version) -->
        <div id="stepName" style="text-align:center;">
            <h1 data-i18n="intro_title" style="color:#ffffff; margin-bottom:30px; font-size:2.2em;">目覚め</h1>
            <p data-i18n="intro_description" style="font-size:1.3em; line-height:1.8;">
                あなたは記憶を失った状態で目を覚ました。<br>
                ルナとカイトという二人が、あなたの幼なじみだと名乗り、<br>
                あなたの名前や過去を教えてくれようとしています。<br><br>
                ゲーム内で使用するあなたの名前を入力してください。
            </p>
            <input type="text" id="playerNameInput" data-i18n-placeholder="intro_name_placeholder" placeholder="名前を入力..." maxlength="12" 
                style="padding:15px; font-size:1.2em; width:300px; margin:20px 0; border-radius:8px; border:none; text-align:center;">
            <br>
            <button onclick="startIntroDialogue()" data-i18n="intro_decide_button"
                style="padding:12px 40px; font-size:1.2em; background:#5f5f5f; color:white; border:none; border-radius:8px; cursor:pointer; margin-top:20px;">
                決定
            </button>
        </div>
            
            <!-- ステップ2: 対話シーン -->
            <div id="stepDialogue" style="display:none;">
                <h1 data-i18n="intro_title" style="color:#ffffff; text-align:center; margin-bottom:30px; font-size:2.2em;">目覚め</h1>
                
                <div id="dialogueBox" style="background:#747474; padding:20px; border-radius:12px; min-height:300px; font-size:1.2em; line-height:1.8;">
                    <!-- ここにJSで対話が挿入されます -->
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button id="nextBtn" onclick="nextDialogue()" 
                            style="padding:12px 40px; font-size:1.2em; background:#5f5f5f; color:white; border:none; border-radius:8px; cursor:pointer;">
                        次へ
                    </button>
                </div>
            </div>
        </div>
    </div>    
    <div id="day"></div>
    <div class="buttons">
        
        <button onclick="playTutorialDialogue()" data-i18n="tutorial">説明</button>



        <button onclick="openSlotMenu('save')" data-i18n="save">保存</button>
        <button onclick="openSlotMenu('load')" data-i18n="load">読み込み</button>
        <button onclick="toggleShop()" data-i18n="shop">店</button>
        <button onclick="toggleCharacters()" data-i18n="characters">キャラクター</button>
        <button onclick="toggleNPCs()" data-i18n="npcs">NPC</button>
        <button onclick="toggleFacilities()" data-i18n="facilities">ギルド周辺</button>
        <button onclick="toggleGuildQuests()" data-i18n="guild_quests">ギルドクエスト投稿</button>
        <button onclick="playDay()" data-i18n="end_day">日終了 & 冒険者派遣</button>
    </div>

    <div class="main">
        <div class="left">
            <div class="quest-nav">
                <h2 data-i18n="quests_title">クエスト&nbsp;&nbsp;&nbsp;</h2>
                <button onclick="prevQuest()" data-i18n="prev_quest">‹ 前</button>
                <span id="questCounter"></span>
                <button onclick="nextQuest()" data-i18n="next_quest">次 ›</button>
            </div>
            <div id="quests"></div>            
        </div>
        <div class="right">
            <h3 style="text-align:center; color:#ffffff; text-shadow:0 0 8px rgba(0,0,0,0.8); margin-bottom:20px;" data-i18n="available_adventurers">利用可能冒険者</h3>
            <div id="availableAdvs" class="horizontal-scroll-container"></div>

            <h3 style="text-align:center; color:#ffffff; text-shadow:0 0 8px rgba(0,0,0,0.8); margin:30px 0 20px;" data-i18n="recruiting_adventurers">募集冒険者</h3>
            <div id="recruits"></div>
        </div>
    </div>

    <div id="eventModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <div id="modalContent"></div>
            <div class="modal-buttons">
                <button id="prevBtn" onclick="prevPage()" data-i18n="prev_page">前</button>
                <span id="pageInfo"></span>
                <button id="nextBtn" onclick="nextPage()" data-i18n="next_page">次</button>
                <button onclick="closeModal()" data-i18n="close">閉じる</button>
            </div>
        </div>
    </div>

    <div id="shopModal">
        <div class="modal-content">
            <h2 data-i18n="shop_title">店</h2>
            <div id="shopContent"></div>
            <div class="modal-buttons">
                <button onclick="closeShop()" data-i18n="close">閉じる</button>
            </div>
        </div>
    </div>

    <div id="charactersModal">
        <div class="modal-content">
            <h2 data-i18n="characters_title">キャラクター</h2>          
            <div id="charactersContent"></div>
            <div class="modal-buttons">
                <button onclick="closeCharacters()" data-i18n="close">閉じる</button>
            </div>               
        </div>
    </div>

    <div id="npcsModal">
        <div class="modal-content">
            <h2 data-i18n="npcs_title">NPC</h2>
            <button onclick="closeNPCs()" data-i18n="close">閉じる</button>
            <div id="npcsContent"></div>
        </div>
    </div>

    <div id="battleModal">
        <div class="modal-content">
            <h3 id="battleTitle" data-i18n="battle_title">防衛戦</h3>
            <div id="battleContent"></div>
        </div>
    </div>

    <div id="facilitiesModal">
        <div class="modal-content">
            <h2 data-i18n="facilities_title">ギルド周辺</h2>
            <div class="modal-buttons">
                <button onclick="closeFacilities()" data-i18n="close">閉じる</button>
            </div>            
            <div id="facilitiesContent"></div>
        </div>
    </div>

    <div id="guildQuestsModal">
        <div class="modal-content">
            <h2 data-i18n="guild_quests_title">ギルドクエスト投稿</h2>
            <div class="modal-buttons">
                <button onclick="closeGuildQuests()" data-i18n="close">閉じる</button>
            </div>            
            <div id="guildQuestsContent"></div>
        </div>
    </div>
<div id="lunaChatModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10001; justify-content:center; align-items:center;">
    <div style="width:90%; max-width:800px; background:#222; border-radius:12px; padding:20px; position:relative;">
        <button onclick="closeNpcChat()" style="position:absolute; top:10px; right:10px; background:#555; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer;">
            閉じる
        </button>
        
        <h2 style="text-align:center; color:#ffd700; margin-bottom:20px;">ルナと会話</h2>
        
        <div style="height:400px; overflow-y:auto; background:#111; padding:15px; border-radius:8px; margin-bottom:15px;" id="lunaChatLog">
            <!-- メッセージがここに追加されます -->
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="lunaInput" placeholder="メッセージを入力..." style="flex:1; padding:12px; background:#333; color:white; border:none; border-radius:8px;" onkeypress="if(event.key==='Enter') sendNpcMessage()">
            <button onclick="sendNpcMessage()" style="padding:12px 24px; background:#5f5f5f; color:white; border:none; border-radius:8px; cursor:pointer;">
                送信
            </button>
        </div>
    </div>
</div>
    <!-- Load translations first -->
    <script src="player2.js"></script>
    <script src="translations.js"></script>
    <script src="constants.js"></script>
    
    <script src="javascript.js"></script>
    <script src="player2_config.js"></script>
<!-- === 2. グローバルアニメーションスクリプト：この <script> ブロック全体を </body> の直前に直接貼り付けてください === -->
<!-- （createElementを使わず、直接 <script> として記述。MutationObserverで動的追加にも完全対応） -->
<!-- === 更新されたグローバルスクリプト： </body> 直前の <script> をこの新しいものに置き換え === -->
<!-- 変更点：animatedクラスを外側ラッパー（.sprite-wrapper）に追加 -->
<script>
(function() {
  console.log('Breathing animation global script loaded and active (stable gray background fix)');

  function initBreathingElement(innerEl) {
    if (innerEl.classList.contains('initialized')) return;
    innerEl.classList.add('initialized');

    var filename = innerEl.dataset.spritesheet;
    if (!filename) {
      console.warn('No spritesheet specified for breathing element', innerEl);
      return;
    }

    console.log('Initializing breathing animation for: Images/' + filename);

    var img = new Image();
    img.onload = function() {
      console.log('Successfully loaded breathing spritesheet: Images/' + filename + ' (size: ' + img.naturalWidth + 'x' + img.naturalHeight + ')');

      var rows = Number(innerEl.dataset.rows);
      var cols = Number(innerEl.dataset.cols);
      var frameW = Number(innerEl.dataset.frameWidth);
      var frameH = Number(innerEl.dataset.frameHeight);
      var durationSec = Number(innerEl.dataset.cycleDuration) || 3.6;
      var totalFrames = rows * cols;

      innerEl.style.backgroundImage = 'url("Images/' + filename + '")';
      innerEl.style.backgroundSize = (cols * frameW) + 'px ' + (rows * frameH) + 'px';
      innerEl.style.backgroundPosition = '0px 0px';

      // アニメ開始 + フォールバック（静止画）をフェードアウト
      var wrapper = innerEl.parentElement;
      wrapper.classList.add('animated');

      var startTime = performance.now();
      var durationMs = durationSec * 1000;

      function animate(time) {
        var elapsed = (time - startTime) % durationMs;
        var progress = elapsed / durationMs;
        var frameIndex = Math.floor(progress * totalFrames) % totalFrames; // フラッシュ防止

        var col = frameIndex % cols;
        var row = Math.floor(frameIndex / cols);
        var x = -col * frameW;
        var y = -row * frameH;

        innerEl.style.backgroundPosition = x + 'px ' + y + 'px';

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);
    };
    img.onerror = function(err) {
      console.error('Failed to load breathing spritesheet: Images/' + filename, err);
      var wrapper = innerEl.parentElement;
      wrapper.classList.remove('animated');
      // フォールバック静止画 + placeholder が表示されたまま
    };
    img.src = 'Images/' + filename;
  }

  var elements = document.querySelectorAll('.sprite-breathing');
  elements.forEach(initBreathingElement);

  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) {
          if (node.classList && node.classList.contains('sprite-breathing')) {
            initBreathingElement(node);
          }
          var children = node.querySelectorAll ? node.querySelectorAll('.sprite-breathing') : [];
          children.forEach(initBreathingElement);
        }
      });
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });

  console.log('Breathing animation observer active – stable gray background applied');
})();
</script>
</body>


</html>