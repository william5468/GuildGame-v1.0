<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>失われし冒険の旅</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- === 更新された共通スタイル： <head> 内の重複した <style> を削除し、この1つの <style> に置き換えてください === -->
<style>
.sprite-wrapper {
  width: inherit;
  height: inherit;

  position: relative;
  overflow: hidden;
  margin: 0 auto;
  border-radius: 12px;
}

.sprite-wrapper::after {
  content: "";
  position: absolute;
  inset: 0;
  background-image: var(--fallback-img), url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMjAiIGhlaWdodD0iNDAwIiB2aWV3Qm94PSIwIDAgMjIwIDQwMCI+PHJlY3Qgd2lkdGg9IjIyMCIgaGVpZ2h0PSI0MDAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCB4PSIxMTAiIHk9IjIwMCIgZm9udC1zaXplPSIzMCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuOCpuODiOOBpzwvdGV4dD48L3N2Zz4=');
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 1;
  transition: opacity 0.5s ease;
  pointer-events: none;
}

.sprite-wrapper.animated::after {
  opacity: 0;
}

.sprite-breathing {
  background-repeat: no-repeat;
  background-color: transparent;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(var(--scale)) translateY(var(--vertical-offset, 0%));
  transform-origin: center center;
  image-rendering: pixelated;
}
</style>
    
</head>
<body>
<div id="dayTransitionOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; justify-content:center; align-items:center; flex-direction:column; color:#fff; pointer-events:none;">
    <h1 id="transitionMessage" style="font-size:3em; color:#fff; margin:0; text-shadow:0 0 20px #f6e582; opacity:0.9;"></h1>
    <p id="transitionDayInfo" style="font-size:2em; margin-top:40px;  opacity:0.9;"></p>
</div>
        <!-- ローディング画面 -->
<div id="loadingOverlay">
    <!-- ゲームタイトル（トップ中央） -->
    <h1 class="loading-title" data-i18n="game_title">失われし冒険の旅</h1>

    <!-- 右下のローディング表示 -->
    <div class="loading-bottom">
        <div class="loading-text">NOW LOADING...</div>

        <div class="load-percent" id="loadProgress">0%</div>
    </div>

    <!-- 読み込み完了後に表示されるボタン類（中央下寄せ） -->
    <div class="loading-buttons" style="display:none">
        <button id="readyBtn" onclick="startGame()" data-i18n="new_game_button">最初から始める</button>
        <br>
        <button id="skipIntroBtn"  onclick="skipIntro()" data-i18n="continue_button">続きから始める</button>
        <br>
        <button id="changeAiProviderBtn "  onclick="changeAiProvider()" data-i18n="AI_setting_button">AI設定</button>
        <br>
        <select id="langSelect"  onchange="setLanguage(this.value)" style="padding:8px 12px; margin:10px; font-size:1em;">
            <option value="">Please Select Language</option>
            <option value="zh">繁體中文</option>
            <option value="ja">日本語</option>
            <option value="en">English</option>
        </select>
    </div>
</div>

    <h2 data-i18n="game_title">失われし冒険の旅 v1.0</h2>
    <audio id="main_screen_bgm" loop preload="auto">
        <source src="Audio/main_screen_bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>
    <!-- メインBGM -->
    <audio id="bgm" loop preload="auto">
        <source src="Audio/bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>
    
    <!-- イントロ専用BGM -->
    <audio id="introBgm" loop preload="auto">
        <source src="Audio/yume.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>
    <audio id="dialogueBgm" loop preload="auto">
        <source src="Audio/dialogue_bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>   
    <audio id="QuestEndDialogueBgm" loop preload="auto">
        <source src="Audio/QuestEndDialogue_bgm.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>    
        <audio id="GameoverBgm" loop preload="auto">
        <source src="Audio/Gameover.mp3" type="audio/mpeg">
        ブラウザがオーディオをサポートしていません。
    </audio>  
    <audio id="battleBgm" loop preload="auto">
        <source src="Audio/battle.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleBgm2" loop preload="auto">
        <source src="Audio/battle2.mp3" type="audio/mpeg">
    </audio>
<div id="introModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center; padding:10px; box-sizing:border-box; overflow-y:auto;">
    <div id="introModal_inner" style="max-height:92vh; overflow-y:auto; width:100%; max-width:900px; margin:0 auto; background:#484848; border:4px solid #535353; border-radius:15px; padding:0px; color:white;  box-sizing:border-box; display:flex; flex-direction:column; justify-content:center;">
        
        <!-- ステップ1: 名前入力 -->
        <div id="stepName" style="text-align:center;">
            <h1 data-i18n="intro_title" style="color:#ffffff; margin-bottom:30px; font-size:2.2em;">目覚め</h1>
            <p data-i18n="intro_description" style="font-size:1.3em; line-height:1.8; margin-bottom:30px;">
                ゲーム内で使用するあなたの名前を入力してください。
            </p>
            <input type="text" id="playerNameInput" data-i18n-placeholder="intro_name_placeholder" placeholder="名前を入力..." maxlength="12" 
                style="padding:15px; font-size:1.2em; width:90%; max-width:300px; margin:20px 0; border-radius:8px; border:none; text-align:center; background:#333; color:white;">
            <br>
            <button onclick="startIntroDialogue()" data-i18n="intro_decide_button"
                style="padding:14px 50px; font-size:1.3em; background:#fcfcfc00; color:white; border:none; border-radius:12px; cursor:pointer; margin-top:20px; box-shadow:0 6px 20px rgba(252, 252, 252, 0.599);">
                決定
            </button>
        </div>
        
        <!-- ステップ2: 対話シーン（クリックエリア拡大 + 継続インジケーター追加） -->
        <div id="stepDialogue" style="display:none; position:relative; width:100%; height:100%; min-height:80vh; text-align:center; cursor:pointer;">
            <!-- 背景（温かい部屋の画像） -->
            <div id="introBG" style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('Images/intro_bg.jpg') center/cover no-repeat; opacity:0.9; pointer-events:none;"></div>
            
            <!-- キャラクター画像（中央配置、大きく） -->
            <div id="introCharacterWrapper" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; max-width:550px; pointer-events:none; z-index:1; border:none">
                <img id="introCharacterImg" src="" alt="キャラクター" style="width:100%; height:80%;  border:none">
            </div>

            <!-- 半透明ダイアログボックス（下部中央） -->
            <div id="dialogueBox" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); width:80%; max-width:900px; background:rgba(0,0,0,0.65);  border-radius:10px; padding:25px 35px; color:white; box-shadow:0 10px 40px rgba(0,0,0,0.8); z-index:2; pointer-events:none;">
                <div id="speakerName" style="font-size:1.5em; font-weight:bold; margin-bottom:12px; color:#ffccaa; text-shadow:0 0 8px rgba(255,204,170,0.5);"></div>
                <div id="dialogueText" style="font-size:1em; line-height:1.6; min-height:80px; "></div>
                
                <!-- 継続インジケーター（タイピング完了時に表示） -->
                <div id="continueIndicator" style="position:absolute; bottom:15px; right:25px; font-size:1em; color:#ffffff; opacity:0; transition:opacity 0.5s ease; pointer-events:none; background: transparent">▶</div>
            </div>
        </div>
    </div>
</div>

<!-- index.html に追加/置き換え（introModalの下に配置） -->

    <div id="day"></div>
<div class="buttons" id="UI_buttons">
    <button class="ui-button" onclick="playTutorialDialogue()">
        <i class="fas fa-circle-info"></i>
        <span data-i18n="tutorial">説明</span>
    </button>

    <button class="ui-button" onclick="openSlotMenu('save')">
        <i class="fas fa-save"></i>
        <span data-i18n="save">保存</span>
    </button>

    <button class="ui-button" onclick="openSlotMenu('load')">
        <i class="fas fa-folder-open"></i>
        <span data-i18n="load">読み込み</span>
    </button>

    <button class="ui-button" onclick="toggleShop()">
        <i class="fas fa-store"></i>
        <span data-i18n="shop">店</span>
    </button>
<button class="ui-button" onclick="toggleInventory()">
    <i class="fas fa-bag-shopping"></i>
    <span data-i18n="inventory">インベントリ</span>
</button>
    <button class="ui-button" onclick="toggleCharacters()">
        <i class="fas fa-users"></i>
        <span data-i18n="characters">キャラクター</span>
    </button>

    <button class="ui-button" onclick="toggleNPCs()">
        <i class="fas fa-comment-dots"></i>
        <span data-i18n="npcs">NPC</span>
    </button>

    <button class="ui-button" onclick="toggleFacilities()">
        <i class="fas fa-building"></i>
        <span data-i18n="facilities">ギルド周辺</span>
    </button>

    <button class="ui-button" onclick="toggleGuildQuests()">
        <i class="fas fa-scroll"></i>
        <span data-i18n="guild_quests">ギルドクエスト投稿</span>
    </button>

    <button class="ui-button" onclick="playDay()">
        <i class="fas fa-fast-forward"></i>
        <span data-i18n="end_day">日終了 & 冒険者派遣</span>
    </button>
</div>

    <div class="main">
        <div class="left">
            <div class="quest-nav">
                <h2 data-i18n="quests_title">クエスト&nbsp;&nbsp;&nbsp;</h2>
                <button onclick="prevQuest()" data-i18n="prev_quest">‹ 前</button>
                <span id="questCounter"></span>
                <button onclick="nextQuest()" data-i18n="next_quest">次 ›</button>
            </div>
            <div id="quests"></div>            
        </div>
        <div class="right">
            <h3 style="text-align:center; color:#ffffff; text-shadow:0 0 8px rgba(0,0,0,0.8); margin-bottom:20px;" data-i18n="available_adventurers">利用可能冒険者</h3>
            <div id="availableAdvs" class="horizontal-scroll-container"></div>

            <h3 style="text-align:center; color:#ffffff; text-shadow:0 0 8px rgba(0,0,0,0.8); margin:30px 0 20px;" data-i18n="recruiting_adventurers">募集冒険者</h3>
            <div id="recruits"></div>
        </div>
    </div>

    <div id="eventModal">
        <div class="modal-content">
            <div id="modalContent"></div>
            <div class="modal-buttons">
                <button id="prevBtn" onclick="prevPage()" data-i18n="prev_page">前</button>
                <span id="pageInfo"></span>
                <button id="nextBtn" onclick="nextPage()" data-i18n="next_page">次</button>
                <button onclick="closeModal()" data-i18n="close">閉じる</button>
            </div>
        </div>
    </div>

    <div id="shopModal">
        <div class="modal-content">
            <h2 data-i18n="shop_title">店</h2>
            <div id="shopContent"></div>
            <div class="modal-buttons">
                <button onclick="closeShop()" data-i18n="close">閉じる</button>
            </div>
        </div>
    </div>

    <div id="charactersModal">
        <div class="modal-content">
            <h2 data-i18n="characters_title">キャラクター</h2>          
            <div id="charactersContent"></div>
            <div class="modal-buttons">
                <button onclick="closeCharacters()" data-i18n="close">閉じる</button>
            </div>               
        </div>
    </div>

    <div id="npcsModal">
        <div class="modal-content">
            <h2 data-i18n="npcs_title">NPC</h2>
            <button onclick="closeNPCs()" data-i18n="close">閉じる</button>
            <div id="npcsContent"></div>
        </div>
    </div>

    <div id="battleModal">
        <div class="modal-content">
            <h3 id="battleTitle" data-i18n="battle_title">防衛戦</h3>
            <div id="battleContent"></div>
        </div>
    </div>

    <div id="facilitiesModal">
        <div class="modal-content">
            <h2 data-i18n="facilities_title">ギルド周辺</h2>
            <div class="modal-buttons">
                <button onclick="closeFacilities()" data-i18n="close">閉じる</button>
            </div>            
            <div id="facilitiesContent"></div>
        </div>
    </div>

    <div id="guildQuestsModal">
        <div class="modal-content">
            <h2 data-i18n="guild_quests_title">ギルドクエスト投稿</h2>
            <div class="modal-buttons">
                <button onclick="closeGuildQuests()" data-i18n="close">閉じる</button>
            </div>            
            <div id="guildQuestsContent"></div>
        </div>
    </div>
<div id="lunaChatModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10001; justify-content:center; align-items:center;">
    <div style="width:90%; max-width:800px; background:#222; border-radius:12px; padding:20px; position:relative; display:flex; flex-direction:column; height:90vh; max-height:900px;">
        <button onclick="closeNpcChat()" style="position:absolute; top:10px; right:10px; background:#555; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; z-index:10;">
            閉じる
        </button>
        
        <h2 style="text-align:center; color:#ffd700; margin:0 0 15px 0; padding:0;">ルナと会話</h2>
        
        <!-- チャットログ（贈り物閉時も最大スペース確保） -->
        <div style="flex:1; min-height:0; overflow-y:auto; background:#111; padding:15px; border-radius:8px; margin-bottom:15px;" id="lunaChatLog">
            <!-- メッセージがここに追加されます -->
        </div>
        
        <!-- 贈り物セクション（初期非表示） -->
        <div id="giftSection" style="display:none; margin-bottom:15px; padding:15px; background:#333; border-radius:8px; color:white;">
            <h3 style="margin:0 0 12px 0; color:#ffd700; text-align:center; font-size:1.2em;">贈り物</h3>
            
            <!-- ゴールドとアイテムを1行に -->
            <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:center; justify-content:center;">
                <!-- ゴールド -->
                <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:220px;">
                    <label style="white-space:nowrap;">ゴールド:</label>
                    <input type="number" id="giftGoldInput" min="0" value="0" style="width:100px; padding:6px; background:#444; color:white; border:none; border-radius:4px;">

                </div>
                
                <!-- アイテム -->
                <div style="display:flex; align-items:center; gap:8px; flex:2; min-width:280px;">
                    <select id="giftItemSelect" onchange="updateGiftQtyMax()" style="flex:1; max-width:180px; padding:6px; background:#444; color:white; border:none; border-radius:4px;"></select>
                    <input type="number" id="giftQtyInput" min="1" value="1" style="width:70px; padding:6px; background:#444; color:white; border:none; border-radius:4px; margin-right:4px; display:none;">
                    <span style="display:none; margin-right:8px;">個</span>

                </div>
            </div>
            
            <!-- NPCのバッグ表示 -->
            <div id="npcBagDisplay" style="margin-top:15px; font-size:0.95em; line-height:1.5; background:#222; padding:10px; border-radius:4px; max-height:100px; overflow-y:auto;">
                <!-- ここにバッグ内容がJSで挿入されます -->
            </div>
        </div>
        
        <!-- メッセージ入力 + 贈り物トグルボタン -->
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="lunaInput" placeholder="メッセージを入力..." style="flex:1; padding:12px; background:#333; color:white; border:none; border-radius:8px;" onkeypress="if(event.key==='Enter') submitChatAndGifts()">
            <button onclick="submitChatAndGifts()" style="padding:12px 24px; background:#5f5f5f; color:white; border:none; border-radius:8px; cursor:pointer;">
                送信
            </button>
            <button id="toggleGiftBtn" onclick="toggleGiftSection()" style="padding:12px 16px; background:#444; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">
                贈り物 ▼
            </button>
        </div>
    </div>
</div>

<!-- OpenRouter専用チャットモーダル（Player2のlunaChatModalと完全に独立） -->
<div id="OpenrouterChatModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center;">
    <div style="width:90%; max-width:800px; background:#222; border-radius:12px; padding:20px; position:relative; display:flex; flex-direction:column; height:90vh; max-height:900px;">
        <button onclick="closeOpenRouterChat()" style="position:absolute; top:10px; right:10px; background:#555; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; z-index:10;">
            閉じる
        </button>
        
        <h2 style="text-align:center; color:#ffd700; margin:0 0 15px 0; padding:0;">NPCと会話</h2>
        
        <!-- チャットログ -->
        <div style="flex:1; min-height:0; overflow-y:auto; background:#111; padding:15px; border-radius:8px; margin-bottom:15px;" id="openRouterChatLog">
            <!-- メッセージがここに追加されます -->
        </div>
        
        <!-- 贈り物セクション（初期非表示） -->
        <div id="giftSection_OR" style="display:none; margin-bottom:15px; padding:15px; background:#333; border-radius:8px; color:white;">
            <h3 style="margin:0 0 12px 0; color:#ffd700; text-align:center; font-size:1.2em;">贈り物</h3>
            
            <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:center; justify-content:center;">
                <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:220px;">
                    <label style="white-space:nowrap;">ゴールド:</label>
                    <input type="number" id="giftGoldInput_OR" min="0" value="0" style="width:100px; padding:6px; background:#444; color:white; border:none; border-radius:4px;">
                </div>
                
                <div style="display:flex; align-items:center; gap:8px; flex:2; min-width:280px;">
                    <select id="giftItemSelect_OR" onchange="updateGiftQtyMax_OR()" style="flex:1; max-width:180px; padding:6px; background:#444; color:white; border:none; border-radius:4px;"></select>
                    <input type="number" id="giftQtyInput_OR" min="1" value="1" style="width:70px; padding:6px; background:#444; color:white; border:none; border-radius:4px; margin-right:4px; display:none;">
                    <span style="display:none; margin-right:8px;">個</span>
                </div>
            </div>
            
            <!-- NPCのバッグ表示 -->
            <div id="npcBagDisplay_OR" style="margin-top:15px; font-size:0.95em; line-height:1.5; background:#222; padding:10px; border-radius:4px; max-height:100px; overflow-y:auto;">
                <!-- ここにバッグ内容がJSで挿入されます -->
            </div>
        </div>
        
        <!-- メッセージ入力 + 贈り物トグルボタン -->
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="openRouterInput" placeholder="メッセージを入力..." style="flex:1; padding:12px; background:#333; color:white; border:none; border-radius:8px;" onkeypress="if(event.key==='Enter') submitChatAndGifts_OR()">
            <button onclick="submitChatAndGifts_OR()" style="padding:12px 24px; background:#5f5f5f; color:white; border:none; border-radius:8px; cursor:pointer;">
                送信
            </button>
            <button id="toggleGiftBtn_OR" onclick="toggleGiftSection_OR()" style="padding:12px 16px; background:#444; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">
                贈り物 ▼
            </button>
        </div>
    </div>
</div>

<!-- インベントリモーダル（中央ポップアップ版） -->
<div id="inventoryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center; padding:20px; box-sizing:border-box;">
    <div class="modal-content" style="max-width:900px; width:100%; max-height:90vh; background:#222; border-radius:15px; padding:20px; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.8);">
        <h2 style="text-align:center; color:#ffd700; margin-bottom:20px; text-shadow:0 0 10px rgba(0,0,0,0.8);" data-i18n="inventory_title">Inventory</h2>
        <div id="inventoryContent" style="padding:10px; background: transparent"></div>
        <div class="modal-buttons" style="text-align:center; margin-top:30px; background: transparent">
            <button onclick="closeInventory()" data-i18n="close" style="padding:12px 40px; font-size:1.2em; background:#c0392b; border:none; border-radius:8px; color:white; cursor:pointer;">閉じる</button>
        </div>
    </div>
</div>
    <!-- Load translations first -->
    <script src="player2.js"></script>
    
    <script src="translations.js"></script>
    <script src="constants.js"></script>
    
    <script src="javascript.js"></script>
    <script src="openrouter.js"></script>
    <script src="player2_config.js"></script>
    <script src="quests.js"></script>
<!-- === 2. グローバルアニメーションスクリプト：この <script> ブロック全体を </body> の直前に直接貼り付けてください === -->
<!-- （createElementを使わず、直接 <script> として記述。MutationObserverで動的追加にも完全対応） -->
<!-- === 更新されたグローバルスクリプト： </body> 直前の <script> をこの新しいものに置き換え === -->
<!-- 変更点：animatedクラスを外側ラッパー（.sprite-wrapper）に追加 -->
<script>
(function() {
  console.log('Breathing animation global script loaded and active (stable gray background fix)');

  function initBreathingElement(innerEl) {
    if (innerEl.classList.contains('initialized')) return;
    innerEl.classList.add('initialized');

    var filename = innerEl.dataset.spritesheet;
    if (!filename) {
      console.warn('No spritesheet specified for breathing element', innerEl);
      return;
    }

    console.log('Initializing breathing animation for: Images/' + filename);

    var img = new Image();
    img.onload = function() {
      console.log('Successfully loaded breathing spritesheet: Images/' + filename + ' (size: ' + img.naturalWidth + 'x' + img.naturalHeight + ')');

      var rows = Number(innerEl.dataset.rows);
      var cols = Number(innerEl.dataset.cols);
      var frameW = Number(innerEl.dataset.frameWidth);
      var frameH = Number(innerEl.dataset.frameHeight);
      var durationSec = Number(innerEl.dataset.cycleDuration) || 3.6;
      var totalFrames = rows * cols;

      innerEl.style.backgroundImage = 'url("Images/' + filename + '")';
      innerEl.style.backgroundSize = (cols * frameW) + 'px ' + (rows * frameH) + 'px';
      innerEl.style.backgroundPosition = '0px 0px';

      // アニメ開始 + フォールバック（静止画）をフェードアウト
      var wrapper = innerEl.parentElement;
      wrapper.classList.add('animated');

      var startTime = performance.now();
      var durationMs = durationSec * 1000;

      function animate(time) {
        var elapsed = (time - startTime) % durationMs;
        var progress = elapsed / durationMs;
        var frameIndex = Math.floor(progress * totalFrames) % totalFrames; // フラッシュ防止

        var col = frameIndex % cols;
        var row = Math.floor(frameIndex / cols);
        var x = -col * frameW;
        var y = -row * frameH;

        innerEl.style.backgroundPosition = x + 'px ' + y + 'px';

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);
    };
    img.onerror = function(err) {
      console.error('Failed to load breathing spritesheet: Images/' + filename, err);
      var wrapper = innerEl.parentElement;
      wrapper.classList.remove('animated');
      // フォールバック静止画 + placeholder が表示されたまま
    };
    img.src = 'Images/' + filename;
  }

  var elements = document.querySelectorAll('.sprite-breathing');
  elements.forEach(initBreathingElement);

  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) {
          if (node.classList && node.classList.contains('sprite-breathing')) {
            initBreathingElement(node);
          }
          var children = node.querySelectorAll ? node.querySelectorAll('.sprite-breathing') : [];
          children.forEach(initBreathingElement);
        }
      });
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });

  console.log('Breathing animation observer active – stable gray background applied');
})();
</script>


</body>


</html>